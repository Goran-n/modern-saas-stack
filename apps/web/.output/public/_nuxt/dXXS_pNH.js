var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import __nuxt_component_0 from"./BcaT81vg.js";import __nuxt_component_2$1 from"./BPHwrUJ4.js";import __nuxt_component_2 from"./Bz_D0D9p.js";import __nuxt_component_3 from"./CFR3RaO-.js";import __nuxt_component_4 from"./BhmyzXKq.js";import{u as useQuery}from"./BHHfj2p6.js";import{e as useTenantStore,i as useSeoMeta}from"./BGn8T2aB.js";import{_ as _sfc_main$1}from"./DIbFRL3M.js";import{_ as _sfc_main$2}from"./DqfWNI9s.js";import{_ as _sfc_main$3}from"./DOdfRuNH.js";import SupplierLogo from"./Dik3jxux.js";import{u as useApi}from"./Cw4ufSzG.js";import{z as defineComponent,f as ref,E as computed,y as watch,A as onMounted,O as createElementBlock,a2 as createBaseVNode,V as createBlock,G as unref,L as Fragment,a8 as renderList,X as createVNode,W as withCtx,a3 as toDisplayString,a5 as createCommentVNode,ad as Teleport,P as openBlock}from"./BRSJK7Xo.js";import"./CEfzLdwR.js";import"./B8R4opHw.js";import"./Eih1rzpN.js";import"./rIxWFMco.js";import"./DQ8mAaII.js";import"./ksLeJgyi.js";import"./kTO7q3pb.js";import"./BD-eHdPR.js";import"./DGtf3NT_.js";import"./Dz2rOXF_.js";import"./B8fQSm5j.js";import"./DYqtA-qf.js";import"./UK4U8T1g.js";import"./IVknCLDK.js";import"./V6c1Z3HZ.js";import"./hXgEKzhh.js";import"./DUt60K_l.js";import"./J5AnXiKH.js";import"./DOQLo0N3.js";import"./CRqHsWWV.js";import"./DZIja_gQ.js";import"./CLyYPccJ.js";import"./Dfp1CywP.js";import"./YOLQlrHt.js";import"./B0BnaaMQ.js";import"./LqpTdS2-.js";import"./zJvaikBT.js";import"./BzzzcPO6.js";import"./BzjSxxHY.js";const _hoisted_1={class:"h-screen bg-neutral-50 grid grid-cols-[320px_1fr]"},_hoisted_2={class:"border-r border-neutral-200 bg-white overflow-y-auto"},_hoisted_3={class:"overflow-y-auto col-span-1"},_hoisted_4={class:"p-4 md:p-6 max-w-none w-full"},_hoisted_5={class:"mb-6"},_hoisted_6={class:"flex items-center justify-between"},_hoisted_7={class:"mt-1 flex","aria-label":"Breadcrumb"},_hoisted_8={class:"flex items-center space-x-2"},_hoisted_9={class:"flex items-center"},_hoisted_10=["href"],_hoisted_11={class:"flex items-center gap-3"},_hoisted_12={class:"flex rounded-md shadow-sm",role:"group"},_hoisted_13={key:0,class:"space-y-4"},_hoisted_14={key:2},_hoisted_15={class:"mb-4"},_hoisted_16={class:"text-sm text-muted"},_hoisted_17={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"},_hoisted_18=["onClick"],_hoisted_19={class:"aspect-square flex flex-col items-center justify-center"},_hoisted_20={class:"w-12 h-12 mb-3 flex items-center justify-center"},_hoisted_21=["title"],_hoisted_22={class:"mt-2 text-center"},_hoisted_23={class:"text-xs text-muted"},_hoisted_24={key:4},_hoisted_25={class:"mb-4"},_hoisted_26={class:"text-sm text-muted"},_sfc_main=defineComponent({__name:"index",setup(__props){const api=useApi(),tenantStore=useTenantStore(),STORAGE_KEYS={selectedYear:"files_selected_year",selectedSupplier:"files_selected_supplier",selectedStatus:"files_selected_status",currentView:"files_current_view",viewMode:"files_view_mode"},getCurrentYear=__name(()=>new Date().getFullYear().toString(),"getCurrentYear"),selectedYear=ref(null),selectedSupplier=ref(null),selectedStatus=ref(null),currentView=ref("default"),viewMode=ref("grid"),selectedFile=ref(null),selectedTenantId=computed(()=>tenantStore.selectedTenantId),fileDataUnwrapped=computed(()=>fileData.value),{data:fileData,isLoading,error}=useQuery({queryKey:["files-manager",selectedTenantId],queryFn:__name(async()=>{const input={json:{}},data=(await api.get(`/trpc/files.getGroupedByYear?input=${encodeURIComponent(JSON.stringify(input))}`)).result.data.json,transformed={byYear:{},totalFiles:data.totalFiles};for(const[year,yearData]of Object.entries(data.byYear)){transformed.byYear[year]={year:yearData.year,totalFiles:yearData.totalFiles,suppliers:{}};for(const[supplierName,supplierData]of Object.entries(yearData.suppliers))transformed.byYear[year].suppliers[supplierName]={name:supplierName,supplierId:supplierData.supplierId,logoUrl:supplierData.logoUrl,fileCount:supplierData.fileCount,files:supplierData.files?.map(f=>({...f,createdAt:typeof f.createdAt=="string"?f.createdAt:new Date(f.createdAt).toISOString(),processingStatus:f.status||f.processingStatus}))||[]}}return transformed},"queryFn"),enabled:__name(()=>!!selectedTenantId.value,"enabled")}),{data:statusFiles}=useQuery({queryKey:["files-status",selectedTenantId],queryFn:__name(async()=>{const input={json:{}};return(await api.get(`/trpc/files.getProcessingStatus?input=${encodeURIComponent(JSON.stringify(input))}`)).result.data.json},"queryFn"),enabled:__name(()=>!!selectedTenantId.value,"enabled")}),fileToFileItem=__name(file=>({...file,createdAt:typeof file.createdAt=="string"?file.createdAt:file.createdAt.toISOString(),processingStatus:file.status}),"fileToFileItem"),processingFiles=computed(()=>(statusFiles.value?.processing||[]).map(fileToFileItem)),failedFiles=computed(()=>(statusFiles.value?.failed||[]).map(fileToFileItem)),currentSuppliers=computed(()=>{if(currentView.value==="status"||!fileDataUnwrapped.value||!selectedYear.value||selectedSupplier.value)return[];const yearData=fileDataUnwrapped.value.byYear[selectedYear.value];return yearData?Object.entries(yearData.suppliers).map(([name,supplier])=>({id:supplier.supplierId||name,name,supplierId:supplier.supplierId,logoUrl:supplier.logoUrl,fileCount:supplier.fileCount,type:"supplier"})):[]}),currentFiles=computed(()=>{if(currentView.value==="status")return selectedStatus.value==="processing"?processingFiles.value:failedFiles.value;if(!fileDataUnwrapped.value||!selectedYear.value)return[];const yearData=fileDataUnwrapped.value.byYear[selectedYear.value];return yearData?selectedSupplier.value&&yearData.suppliers?.[selectedSupplier.value]?(yearData.suppliers[selectedSupplier.value]?.files||[]).map(f=>typeof f.createdAt=="string"?f:fileToFileItem(f)):[]:[]}),breadcrumbLinks=computed(()=>{const links=[{label:"Files",to:"/files"}];return currentView.value==="status"?links.push({label:selectedStatus.value==="processing"?"Processing":"Failed",to:"/files"}):selectedYear.value&&(links.push({label:selectedYear.value,to:"/files"}),selectedSupplier.value&&links.push({label:selectedSupplier.value,to:"/files"})),links}),handleYearSelected=__name(year=>{selectedYear.value=year,selectedSupplier.value=null,selectedStatus.value=null,currentView.value="default",localStorage.setItem(STORAGE_KEYS.selectedYear,year),localStorage.removeItem(STORAGE_KEYS.selectedSupplier),localStorage.removeItem(STORAGE_KEYS.selectedStatus),localStorage.setItem(STORAGE_KEYS.currentView,"default")},"handleYearSelected"),handleSupplierSelected=__name(supplier=>{selectedSupplier.value=supplier,selectedStatus.value=null,currentView.value="supplier",localStorage.setItem(STORAGE_KEYS.selectedSupplier,supplier),localStorage.removeItem(STORAGE_KEYS.selectedStatus),localStorage.setItem(STORAGE_KEYS.currentView,"supplier")},"handleSupplierSelected"),handleStatusSelected=__name(status=>{selectedStatus.value=status,selectedYear.value=null,selectedSupplier.value=null,currentView.value="status",localStorage.setItem(STORAGE_KEYS.selectedStatus,status),localStorage.removeItem(STORAGE_KEYS.selectedYear),localStorage.removeItem(STORAGE_KEYS.selectedSupplier),localStorage.setItem(STORAGE_KEYS.currentView,"status")},"handleStatusSelected"),handleFileSelected=__name(file=>{file&&(selectedFile.value=file)},"handleFileSelected");return watch(viewMode,newMode=>{localStorage.setItem(STORAGE_KEYS.viewMode,newMode)}),onMounted(()=>{const savedViewMode=localStorage.getItem(STORAGE_KEYS.viewMode);savedViewMode&&(viewMode.value=savedViewMode);const savedView=localStorage.getItem(STORAGE_KEYS.currentView),savedYear=localStorage.getItem(STORAGE_KEYS.selectedYear)||null,savedSupplier=localStorage.getItem(STORAGE_KEYS.selectedSupplier)||null,savedStatus=localStorage.getItem(STORAGE_KEYS.selectedStatus);let unwatch=null;unwatch=watch([fileData,statusFiles],([data,status])=>{if(!data&&!status)return;let hasValidSelection=!1;if(savedView==="status"&&savedStatus?(savedStatus==="processing"?(status?.processing?.length||0)>0:(status?.failed?.length||0)>0)&&(selectedStatus.value=savedStatus,currentView.value="status",hasValidSelection=!0):savedYear&&data?.byYear[savedYear]&&(selectedYear.value=savedYear,currentView.value=savedSupplier?"supplier":"default",savedSupplier&&data.byYear[savedYear].suppliers[savedSupplier]&&(selectedSupplier.value=savedSupplier),hasValidSelection=!0),!hasValidSelection&&data?.byYear){const currentYear=getCurrentYear(),years=Object.keys(data.byYear).sort().reverse();data.byYear[currentYear]?(selectedYear.value=currentYear,currentView.value="default"):years.length>0&&(selectedYear.value=years[0]||null,currentView.value="default")}unwatch&&unwatch()},{immediate:!0})}),useSeoMeta({title:"Files | Figgy",description:"Manage and view your uploaded files organised by year and supplier"}),(_ctx,_cache)=>{const _component_FileManagerSidebar=__nuxt_component_0,_component_Icon=__nuxt_component_2$1,_component_organisms_file_grid=__nuxt_component_2,_component_organisms_file_list=__nuxt_component_3,_component_organisms_file_preview=__nuxt_component_4;return openBlock(),createElementBlock(Fragment,null,[createBaseVNode("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[unref(fileDataUnwrapped)?(openBlock(),createBlock(_component_FileManagerSidebar,{key:0,"file-data":unref(fileDataUnwrapped),"processing-files":unref(processingFiles),"failed-files":unref(failedFiles),"selected-year":unref(selectedYear),"selected-supplier":unref(selectedSupplier),"selected-status":unref(selectedStatus),loading:!!unref(isLoading),onYearSelected:handleYearSelected,onSupplierSelected:handleSupplierSelected,onStatusSelected:handleStatusSelected},null,8,["file-data","processing-files","failed-files","selected-year","selected-supplier","selected-status","loading"])):(openBlock(),createBlock(_component_FileManagerSidebar,{key:1,"processing-files":unref(processingFiles),"failed-files":unref(failedFiles),"selected-year":unref(selectedYear),"selected-supplier":unref(selectedSupplier),"selected-status":unref(selectedStatus),loading:!!unref(isLoading),onYearSelected:handleYearSelected,onSupplierSelected:handleSupplierSelected,onStatusSelected:handleStatusSelected},null,8,["processing-files","failed-files","selected-year","selected-supplier","selected-status","loading"]))]),createBaseVNode("div",_hoisted_3,[createBaseVNode("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[createBaseVNode("div",_hoisted_6,[createBaseVNode("div",null,[_cache[3]||(_cache[3]=createBaseVNode("h1",{class:"text-2xl font-semibold"},"Files",-1)),createBaseVNode("nav",_hoisted_7,[createBaseVNode("ol",_hoisted_8,[(openBlock(!0),createElementBlock(Fragment,null,renderList(unref(breadcrumbLinks),(link,index)=>(openBlock(),createElementBlock("li",{key:index},[createBaseVNode("div",_hoisted_9,[createBaseVNode("a",{href:link.to,class:"text-sm font-medium text-neutral-500 hover:text-neutral-700"},toDisplayString(link.label),9,_hoisted_10),index<unref(breadcrumbLinks).length-1?(openBlock(),createBlock(_component_Icon,{key:0,name:"heroicons:chevron-right",class:"ml-2 h-4 w-4 text-neutral-400"})):createCommentVNode("",!0)])]))),128))])])]),createBaseVNode("div",_hoisted_11,[createBaseVNode("div",_hoisted_12,[createVNode(unref(_sfc_main$1),{variant:unref(viewMode)==="grid"?"solid":"outline",size:"sm",class:"rounded-r-none",onClick:_cache[0]||(_cache[0]=$event=>viewMode.value="grid")},{default:withCtx(()=>[createVNode(_component_Icon,{name:"heroicons:squares-2x2",class:"h-4 w-4"})]),_:1},8,["variant"]),createVNode(unref(_sfc_main$1),{variant:unref(viewMode)==="list"?"solid":"outline",size:"sm",class:"rounded-l-none -ml-px",onClick:_cache[1]||(_cache[1]=$event=>viewMode.value="list")},{default:withCtx(()=>[createVNode(_component_Icon,{name:"heroicons:list-bullet",class:"h-4 w-4"})]),_:1},8,["variant"])])])])]),unref(isLoading)?(openBlock(),createElementBlock("div",_hoisted_13,[(openBlock(),createElementBlock(Fragment,null,renderList(6,i=>createVNode(unref(_sfc_main$2),{class:"h-32 w-full",key:i})),64))])):unref(error)?(openBlock(),createBlock(unref(_sfc_main$3),{key:1,type:"error",description:unref(error)?.message||"There was an error loading your files"},null,8,["description"])):unref(currentSuppliers).length>0?(openBlock(),createElementBlock("div",_hoisted_14,[createBaseVNode("div",_hoisted_15,[createBaseVNode("p",_hoisted_16,toDisplayString(unref(currentSuppliers).length)+" "+toDisplayString(unref(currentSuppliers).length===1?"supplier":"suppliers")+" for "+toDisplayString(unref(selectedYear)),1)]),createBaseVNode("div",_hoisted_17,[(openBlock(!0),createElementBlock(Fragment,null,renderList(unref(currentSuppliers),supplier=>(openBlock(),createElementBlock("div",{key:supplier.id,onClick:__name($event=>handleSupplierSelected(supplier.name),"onClick"),class:"cursor-pointer transition-all duration-200 bg-white rounded-lg border border-neutral-200 hover:border-primary-300 p-4"},[createBaseVNode("div",_hoisted_19,[createBaseVNode("div",_hoisted_20,[createVNode(SupplierLogo,{name:supplier.name,"logo-url":supplier.logoUrl,size:"lg",class:"w-12 h-12"},null,8,["name","logo-url"])]),createBaseVNode("h3",{class:"text-sm font-medium text-center line-clamp-2 hover:text-primary transition-colors",title:supplier.name},toDisplayString(supplier.name),9,_hoisted_21),createBaseVNode("div",_hoisted_22,[createBaseVNode("p",_hoisted_23,toDisplayString(supplier.fileCount)+" "+toDisplayString(supplier.fileCount===1?"file":"files"),1)])])],8,_hoisted_18))),128))])])):unref(currentFiles).length?(openBlock(),createElementBlock("div",_hoisted_24,[createBaseVNode("div",_hoisted_25,[createBaseVNode("p",_hoisted_26,toDisplayString(unref(currentFiles).length)+" "+toDisplayString(unref(currentFiles).length===1?"file":"files")+" "+toDisplayString(unref(currentView)==="supplier"?`from ${unref(selectedSupplier)}`:"")+" "+toDisplayString(unref(currentView)==="status"?unref(selectedStatus):""),1)]),unref(viewMode)==="grid"?(openBlock(),createBlock(_component_organisms_file_grid,{key:0,files:unref(currentFiles),onFileSelected:handleFileSelected},null,8,["files"])):(openBlock(),createBlock(_component_organisms_file_list,{key:1,files:unref(currentFiles),onFileSelected:handleFileSelected},null,8,["files"]))])):(openBlock(),createBlock(unref(_sfc_main$3),{key:3,type:"empty",image:"/empty-coffee-receipts.webp",description:unref(currentView)==="status"?`No ${unref(selectedStatus)} files at the moment`:"Select a year and supplier to view files"},null,8,["description"]))])])]),(openBlock(),createBlock(Teleport,{to:"body"},[unref(selectedFile)?(openBlock(),createBlock(_component_organisms_file_preview,{key:0,file:unref(selectedFile),onClose:_cache[2]||(_cache[2]=$event=>selectedFile.value=null)},null,8,["file"])):createCommentVNode("",!0)]))],64)}}});export{_sfc_main as default};
