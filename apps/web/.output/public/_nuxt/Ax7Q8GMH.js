var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{_ as __nuxt_component_0}from"./BdI7D7Kq.js";import{f as ref,E as computed,A as onMounted,M as useRoute,O as createElementBlock,a2 as createBaseVNode,X as createVNode,a3 as toDisplayString,W as withCtx,G as unref,a9 as createStaticVNode,a5 as createCommentVNode,a4 as createTextVNode,L as Fragment,a8 as renderList,aa as useRouter,P as openBlock,ab as withDirectives,ac as vModelCheckbox}from"./BRSJK7Xo.js";import{a as useSupabaseUser,n as navigateTo}from"./BGn8T2aB.js";import{u as useApi}from"./Cw4ufSzG.js";import{_ as _export_sfc}from"./B0BnaaMQ.js";import"./BzzzcPO6.js";import"./BzjSxxHY.js";import"./DOQLo0N3.js";const _hoisted_1={class:"slack-link-container"},_hoisted_2={class:"slack-link-card"},_hoisted_3={key:0,class:"loading-state"},_hoisted_4={key:1,class:"error-state"},_hoisted_5={key:2,class:"auth-required"},_hoisted_6={key:3,class:"no-tenants"},_hoisted_7={key:4,class:"linking-state"},_hoisted_8={key:5,class:"success-state"},_hoisted_9={class:"button-group"},_hoisted_10={key:6,class:"tenant-selection"},_hoisted_11={key:0},_hoisted_12={class:"tenant-list"},_hoisted_13={class:"checkbox-label"},_hoisted_14=["value","disabled"],_hoisted_15={class:"tenant-name"},_hoisted_16={class:"tenant-role"},_hoisted_17={class:"actions"},_hoisted_18=["disabled"],_sfc_main={__name:"slack-link",setup(__props){const route=useRoute();useRouter();const user=useSupabaseUser(),api=useApi(),loading=ref(!0),linking=ref(!1),linkingComplete=ref(!1),error=ref(""),errorTitle=ref("Error"),tokenInfo=ref(null),tenants=ref([]),selectedTenants=ref([]),linkedTenantNames=computed(()=>{if(!tenants.value||selectedTenants.value.length===0)return"";const selected=tenants.value.filter(t=>selectedTenants.value.includes(t.id)).map(t=>t.name);return selected.length===1?selected[0]:selected.length===2?`${selected[0]} and ${selected[1]}`:`${selected.slice(0,-1).join(", ")}, and ${selected[selected.length-1]}`});onMounted(async()=>{if(!route.query.token){error.value="No linking token provided. Please return to Slack and request a new link.",errorTitle.value="Invalid Link",loading.value=!1;return}if(!user.value){loading.value=!1;return}try{const verifyResult=(await api.post("/trpc/communication.verifySlackLinkingToken",{json:{token:route.query.token}})).result?.data?.json;if(!verifyResult?.valid){error.value="This link has expired or is invalid. Please return to Slack and request a new link.",errorTitle.value="Link Expired",loading.value=!1;return}tokenInfo.value=verifyResult;const userTenants=(await api.get("/trpc/auth.getUserTenants")).result?.data?.json||[];tenants.value=userTenants.map(ut=>({id:ut.tenant.id,name:ut.tenant.name,role:ut.role})),selectedTenants.value=tenants.value.map(t=>t.id),loading.value=!1}catch{error.value="An error occurred while verifying your link. Please try again.",loading.value=!1}});async function signIn(){sessionStorage.setItem("slack-link-return",window.location.href),await navigateTo("/login")}__name(signIn,"signIn");async function linkAccount(){if(!(selectedTenants.value.length===0||!tokenInfo.value)){linking.value=!0,error.value="";try{const linkResult=(await api.post("/trpc/communication.linkSlackAccount",{json:{token:route.query.token,tenantIds:selectedTenants.value}})).result?.data?.json;linkResult?.success?linkingComplete.value=!0:(error.value=linkResult?.error||"Failed to link account",errorTitle.value="Linking Failed")}catch{error.value="An error occurred while linking your account. Please try again.",errorTitle.value="Linking Failed"}finally{linking.value=!1}}}__name(linkAccount,"linkAccount");function selectAll(){selectedTenants.value=tenants.value.map(t=>t.id)}__name(selectAll,"selectAll");function returnToSlack(){window.location.href="slack://open",setTimeout(()=>{window.open("https://app.slack.com","_blank")},1e3)}return __name(returnToSlack,"returnToSlack"),(_ctx,_cache)=>{const _component_NuxtLink=__nuxt_component_0;return openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[loading.value?(openBlock(),createElementBlock("div",_hoisted_3,_cache[1]||(_cache[1]=[createBaseVNode("div",{class:"spinner"},null,-1),createBaseVNode("h2",null,"Verifying your link...",-1)]))):error.value?(openBlock(),createElementBlock("div",_hoisted_4,[_cache[3]||(_cache[3]=createBaseVNode("div",{class:"error-icon"},"âš ï¸",-1)),createBaseVNode("h2",null,toDisplayString(errorTitle.value),1),createBaseVNode("p",null,toDisplayString(error.value),1),createVNode(_component_NuxtLink,{to:"/",class:"button button-secondary"},{default:withCtx(()=>_cache[2]||(_cache[2]=[createTextVNode(" Go to Dashboard ",-1)])),_:1,__:[2]})])):unref(user)?!tenants.value||tenants.value.length===0?(openBlock(),createElementBlock("div",_hoisted_6,[_cache[6]||(_cache[6]=createBaseVNode("div",{class:"error-icon"},"ðŸ”",-1)),_cache[7]||(_cache[7]=createBaseVNode("h2",null,"No Organizations Found",-1)),_cache[8]||(_cache[8]=createBaseVNode("p",null,"You don't have access to any organizations yet. Please contact your administrator.",-1)),createVNode(_component_NuxtLink,{to:"/",class:"button button-secondary"},{default:withCtx(()=>_cache[5]||(_cache[5]=[createTextVNode(" Go to Dashboard ",-1)])),_:1,__:[5]})])):linking.value?(openBlock(),createElementBlock("div",_hoisted_7,_cache[9]||(_cache[9]=[createBaseVNode("div",{class:"spinner"},null,-1),createBaseVNode("h2",null,"Linking your account...",-1),createBaseVNode("p",null,"Please wait while we connect your Slack account.",-1)]))):linkingComplete.value?(openBlock(),createElementBlock("div",_hoisted_8,[_cache[11]||(_cache[11]=createBaseVNode("div",{class:"success-icon"},"âœ…",-1)),_cache[12]||(_cache[12]=createBaseVNode("h2",null,"Account Linked Successfully!",-1)),createBaseVNode("p",null,"Your Slack account has been linked to "+toDisplayString(linkedTenantNames.value)+".",1),_cache[13]||(_cache[13]=createBaseVNode("p",{class:"success-message"},"You can now return to Slack and start using Figgy!",-1)),createBaseVNode("div",_hoisted_9,[createBaseVNode("button",{onClick:returnToSlack,class:"button button-primary"}," Open Slack "),createVNode(_component_NuxtLink,{to:"/",class:"button button-secondary"},{default:withCtx(()=>_cache[10]||(_cache[10]=[createTextVNode(" Go to Dashboard ",-1)])),_:1,__:[10]})])])):(openBlock(),createElementBlock("div",_hoisted_10,[_cache[15]||(_cache[15]=createStaticVNode('<div class="slack-icon" data-v-bb610926><svg width="54" height="54" viewBox="0 0 54 54" xmlns="http://www.w3.org/2000/svg" data-v-bb610926><g fill="none" fill-rule="evenodd" data-v-bb610926><path d="M19.712.133a5.381 5.381 0 0 0-5.376 5.387 5.381 5.381 0 0 0 5.376 5.386h5.376V5.52A5.381 5.381 0 0 0 19.712.133m0 14.365H5.376A5.381 5.381 0 0 0 0 19.884a5.381 5.381 0 0 0 5.376 5.387h14.336a5.381 5.381 0 0 0 5.376-5.387 5.381 5.381 0 0 0-5.376-5.386" fill="#36C5F0" data-v-bb610926></path><path d="M53.76 19.884a5.381 5.381 0 0 0-5.376-5.386 5.381 5.381 0 0 0-5.376 5.386v5.387h5.376a5.381 5.381 0 0 0 5.376-5.387m-14.336 0V5.52A5.381 5.381 0 0 0 34.048.133a5.381 5.381 0 0 0-5.376 5.387v14.364a5.381 5.381 0 0 0 5.376 5.387 5.381 5.381 0 0 0 5.376-5.387" fill="#2EB67D" data-v-bb610926></path><path d="M34.048 54a5.381 5.381 0 0 0 5.376-5.387 5.381 5.381 0 0 0-5.376-5.386h-5.376v5.386A5.381 5.381 0 0 0 34.048 54m0-14.365h14.336a5.381 5.381 0 0 0 5.376-5.386 5.381 5.381 0 0 0-5.376-5.387H34.048a5.381 5.381 0 0 0-5.376 5.387 5.381 5.381 0 0 0 5.376 5.386" fill="#ECB22E" data-v-bb610926></path><path d="M0 34.249a5.381 5.381 0 0 0 5.376 5.386 5.381 5.381 0 0 0 5.376-5.386v-5.387H5.376A5.381 5.381 0 0 0 0 34.25m14.336-.001v14.364A5.381 5.381 0 0 0 19.712 54a5.381 5.381 0 0 0 5.376-5.387V34.25a5.381 5.381 0 0 0-5.376-5.387 5.381 5.381 0 0 0-5.376 5.387" fill="#E01E5A" data-v-bb610926></path></g></svg></div><h2 data-v-bb610926>Link Your Slack Account</h2>',2)),tokenInfo.value?.slackEmail?(openBlock(),createElementBlock("p",_hoisted_11,[_cache[14]||(_cache[14]=createTextVNode(" Linking Slack account: ",-1)),createBaseVNode("strong",null,toDisplayString(tokenInfo.value.slackEmail),1)])):createCommentVNode("",!0),_cache[16]||(_cache[16]=createBaseVNode("p",null,"You have access to the following organizations:",-1)),createBaseVNode("div",_hoisted_12,[(openBlock(!0),createElementBlock(Fragment,null,renderList(tenants.value,tenant=>(openBlock(),createElementBlock("div",{key:tenant.id,class:"tenant-item"},[createBaseVNode("label",_hoisted_13,[withDirectives(createBaseVNode("input",{type:"checkbox","onUpdate:modelValue":_cache[0]||(_cache[0]=$event=>selectedTenants.value=$event),value:tenant.id,disabled:linking.value},null,8,_hoisted_14),[[vModelCheckbox,selectedTenants.value]]),createBaseVNode("span",_hoisted_15,toDisplayString(tenant.name),1),createBaseVNode("span",_hoisted_16,"("+toDisplayString(tenant.role)+")",1)])]))),128))]),createBaseVNode("div",_hoisted_17,[createBaseVNode("button",{onClick:linkAccount,disabled:selectedTenants.value.length===0||linking.value,class:"button button-primary"}," Link Selected Organizations ",8,_hoisted_18),createBaseVNode("button",{onClick:selectAll,class:"button button-secondary"}," Select All ")])])):(openBlock(),createElementBlock("div",_hoisted_5,[_cache[4]||(_cache[4]=createStaticVNode('<div class="slack-icon" data-v-bb610926><svg width="54" height="54" viewBox="0 0 54 54" xmlns="http://www.w3.org/2000/svg" data-v-bb610926><g fill="none" fill-rule="evenodd" data-v-bb610926><path d="M19.712.133a5.381 5.381 0 0 0-5.376 5.387 5.381 5.381 0 0 0 5.376 5.386h5.376V5.52A5.381 5.381 0 0 0 19.712.133m0 14.365H5.376A5.381 5.381 0 0 0 0 19.884a5.381 5.381 0 0 0 5.376 5.387h14.336a5.381 5.381 0 0 0 5.376-5.387 5.381 5.381 0 0 0-5.376-5.386" fill="#36C5F0" data-v-bb610926></path><path d="M53.76 19.884a5.381 5.381 0 0 0-5.376-5.386 5.381 5.381 0 0 0-5.376 5.386v5.387h5.376a5.381 5.381 0 0 0 5.376-5.387m-14.336 0V5.52A5.381 5.381 0 0 0 34.048.133a5.381 5.381 0 0 0-5.376 5.387v14.364a5.381 5.381 0 0 0 5.376 5.387 5.381 5.381 0 0 0 5.376-5.387" fill="#2EB67D" data-v-bb610926></path><path d="M34.048 54a5.381 5.381 0 0 0 5.376-5.387 5.381 5.381 0 0 0-5.376-5.386h-5.376v5.386A5.381 5.381 0 0 0 34.048 54m0-14.365h14.336a5.381 5.381 0 0 0 5.376-5.386 5.381 5.381 0 0 0-5.376-5.387H34.048a5.381 5.381 0 0 0-5.376 5.387 5.381 5.381 0 0 0 5.376 5.386" fill="#ECB22E" data-v-bb610926></path><path d="M0 34.249a5.381 5.381 0 0 0 5.376 5.386 5.381 5.381 0 0 0 5.376-5.386v-5.387H5.376A5.381 5.381 0 0 0 0 34.25m14.336-.001v14.364A5.381 5.381 0 0 0 19.712 54a5.381 5.381 0 0 0 5.376-5.387V34.25a5.381 5.381 0 0 0-5.376-5.387 5.381 5.381 0 0 0-5.376 5.387" fill="#E01E5A" data-v-bb610926></path></g></svg></div><h2 data-v-bb610926>Link Your Slack Account</h2><p data-v-bb610926>Please sign in to link your Slack account with Figgy.</p>',3)),createBaseVNode("button",{onClick:signIn,class:"button button-primary"}," Sign in to Continue ")]))])])}}},slackLink=_export_sfc(_sfc_main,[["__scopeId","data-v-bb610926"]]);export{slackLink as default};
