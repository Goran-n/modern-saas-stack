var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{E as computed,b as toValue,a as getCurrentInstance,aj as onBeforeMount,B as onUnmounted,i as inject,y as watch,H as onScopeDispose,f as ref,l as shallowRef,ak as debounce,t as toRef,C as nextTick,G as unref,g as getCurrentScope,r as reactive,z as defineComponent,A as onMounted,O as createElementBlock,X as createVNode,W as withCtx,a7 as resolveComponent,P as openBlock,a2 as createBaseVNode,a4 as createTextVNode,a3 as toDisplayString,d as isRef,a5 as createCommentVNode,V as createBlock,U as normalizeClass,a6 as withModifiers}from"./BRSJK7Xo.js";import{u as useCommunicationStore}from"./BvRDyO_j.js";import{j as useNuxtApp,D as asyncDataDefaults,C as createError,E as fetchDefaults,e as useTenantStore,i as useSeoMeta,c as useSupabaseClient,g as useRuntimeConfig,a as useSupabaseUser}from"./BGn8T2aB.js";import{_ as _sfc_main$3}from"./BeaoTUGu.js";import{_ as _sfc_main$1}from"./B8fQSm5j.js";import{_ as _sfc_main$2}from"./DUt60K_l.js";import{u as useNotification}from"./Dr_osDAG.js";import{s as serialize}from"./CKrwGQ3G.js";import"./Cw4ufSzG.js";import"./BzzzcPO6.js";import"./BzjSxxHY.js";import"./DOQLo0N3.js";import"./CEfzLdwR.js";import"./B8R4opHw.js";import"./DIbFRL3M.js";import"./LqpTdS2-.js";/**
* @vue/shared v3.5.18
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/const objectToString=Object.prototype.toString,toTypeString=__name(value=>objectToString.call(value),"toTypeString"),isPlainObject=__name(val=>toTypeString(val)==="[object Object]","isPlainObject"),z=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],R=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",r=[],_k=class _k{_data=new l;_hash=new l([...z]);_nDataBytes=0;_minBufferSize=0;finalize(e){e&&this._append(e);const s=this._nDataBytes*8,t=this._data.sigBytes*8;return this._data.words[t>>>5]|=128<<24-t%32,this._data.words[(t+64>>>9<<4)+14]=Math.floor(s/4294967296),this._data.words[(t+64>>>9<<4)+15]=s,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}_doProcessBlock(e,s){const t=this._hash.words;let i=t[0],o=t[1],a=t[2],c=t[3],h=t[4],g=t[5],f=t[6],y=t[7];for(let n=0;n<64;n++){if(n<16)r[n]=e[s+n]|0;else{const d=r[n-15],j=(d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3,B=r[n-2],x=(B<<15|B>>>17)^(B<<13|B>>>19)^B>>>10;r[n]=j+r[n-7]+x+r[n-16]}const m=h&g^~h&f,p=i&o^i&a^o&a,u=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),b=(h<<26|h>>>6)^(h<<21|h>>>11)^(h<<7|h>>>25),w=y+b+m+R[n]+r[n],M=u+p;y=f,f=g,g=h,h=c+w|0,c=a,a=o,o=i,i=w+M|0}t[0]=t[0]+i|0,t[1]=t[1]+o|0,t[2]=t[2]+a|0,t[3]=t[3]+c|0,t[4]=t[4]+h|0,t[5]=t[5]+g|0,t[6]=t[6]+f|0,t[7]=t[7]+y|0}_append(e){typeof e=="string"&&(e=l.fromUtf8(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes}_process(e){let s,t=this._data.sigBytes/64;e?t=Math.ceil(t):t=Math.max((t|0)-this._minBufferSize,0);const i=t*16,o=Math.min(i*4,this._data.sigBytes);if(i){for(let a=0;a<i;a+=16)this._doProcessBlock(this._data.words,a);s=this._data.words.splice(0,i),this._data.sigBytes-=o}return new l(s,o)}};__name(_k,"k");let k=_k;const _l=class _l{words;sigBytes;constructor(e,s){e=this.words=e||[],this.sigBytes=s===void 0?e.length*4:s}static fromUtf8(e){const s=unescape(encodeURIComponent(e)),t=s.length,i=[];for(let o=0;o<t;o++)i[o>>>2]|=(s.charCodeAt(o)&255)<<24-o%4*8;return new _l(i,t)}toBase64(){const e=[];for(let s=0;s<this.sigBytes;s+=3){const t=this.words[s>>>2]>>>24-s%4*8&255,i=this.words[s+1>>>2]>>>24-(s+1)%4*8&255,o=this.words[s+2>>>2]>>>24-(s+2)%4*8&255,a=t<<16|i<<8|o;for(let c=0;c<4&&s*8+c*6<this.sigBytes*8;c++)e.push(S.charAt(a>>>6*(3-c)&63))}return e.join("")}concat(e){if(this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4),this.sigBytes%4)for(let s=0;s<e.sigBytes;s++){const t=e.words[s>>>2]>>>24-s%4*8&255;this.words[this.sigBytes+s>>>2]|=t<<24-(this.sigBytes+s)%4*8}else for(let s=0;s<e.sigBytes;s+=4)this.words[this.sigBytes+s>>>2]=e.words[s>>>2];this.sigBytes+=e.sigBytes}};__name(_l,"l");let l=_l;function digest(_){return new k().finalize(_).toBase64()}__name(digest,"digest");function hash(input){return digest(serialize(input))}__name(hash,"hash");const clientOnlySymbol=Symbol.for("nuxt:client-only");function useAsyncData(...args){const autoKey=typeof args[args.length-1]=="string"?args.pop():void 0;_isAutoKeyNeeded(args[0],args[1])&&args.unshift(autoKey);let[_key,_handler,options={}]=args;const key=computed(()=>toValue(_key));if(typeof key.value!="string")throw new TypeError("[nuxt] [useAsyncData] key must be a string.");if(typeof _handler!="function")throw new TypeError("[nuxt] [useAsyncData] handler must be a function.");const nuxtApp=useNuxtApp();options.server??=!0,options.default??=getDefault,options.getCachedData??=getDefaultCachedData,options.lazy??=!1,options.immediate??=!0,options.deep??=asyncDataDefaults.deep,options.dedupe??="cancel",options._functionName,nuxtApp._asyncData[key.value];const initialFetchOptions={cause:"initial",dedupe:options.dedupe};nuxtApp._asyncData[key.value]?._init||(initialFetchOptions.cachedData=options.getCachedData(key.value,nuxtApp,{cause:"initial"}),nuxtApp._asyncData[key.value]=createAsyncData(nuxtApp,key.value,_handler,options,initialFetchOptions.cachedData));const asyncData=nuxtApp._asyncData[key.value];asyncData._deps++;const initialFetch=__name(()=>nuxtApp._asyncData[key.value].execute(initialFetchOptions),"initialFetch"),fetchOnServer=options.server!==!1&&nuxtApp.payload.serverRendered;{let unregister=__name(function(key2){const data=nuxtApp._asyncData[key2];data?._deps&&(data._deps--,data._deps===0&&data?._off())},"unregister");const instance=getCurrentInstance();if(instance&&fetchOnServer&&options.immediate&&!instance.sp&&(instance.sp=[]),instance&&!instance._nuxtOnBeforeMountCbs){instance._nuxtOnBeforeMountCbs=[];const cbs=instance._nuxtOnBeforeMountCbs;onBeforeMount(()=>{cbs.forEach(cb=>{cb()}),cbs.splice(0,cbs.length)}),onUnmounted(()=>cbs.splice(0,cbs.length))}const isWithinClientOnly=instance&&(instance._nuxtClientOnly||inject(clientOnlySymbol,!1));fetchOnServer&&nuxtApp.isHydrating&&(asyncData.error.value||asyncData.data.value!==void 0)?asyncData.status.value=asyncData.error.value?"error":"success":instance&&(!isWithinClientOnly&&nuxtApp.payload.serverRendered&&nuxtApp.isHydrating||options.lazy)&&options.immediate?instance._nuxtOnBeforeMountCbs.push(initialFetch):options.immediate&&asyncData.status.value!=="success"&&initialFetch();const hasScope=getCurrentScope(),unsubExecute=watch([key,...options.watch||[]],([newKey],[oldKey])=>{if((newKey||oldKey)&&newKey!==oldKey){const hasRun=nuxtApp._asyncData[oldKey]?.data.value!==void 0,isRunning=nuxtApp._asyncDataPromises[oldKey]!==void 0;oldKey&&unregister(oldKey);const initialFetchOptions2={cause:"initial",dedupe:options.dedupe};if(!nuxtApp._asyncData[newKey]?._init){let value;oldKey&&hasRun?value=nuxtApp._asyncData[oldKey]?.data.value:(value=options.getCachedData(newKey,nuxtApp,{cause:"initial"}),initialFetchOptions2.cachedData=value),nuxtApp._asyncData[newKey]=createAsyncData(nuxtApp,newKey,_handler,options,value)}nuxtApp._asyncData[newKey]._deps++,(options.immediate||hasRun||isRunning)&&nuxtApp._asyncData[newKey].execute(initialFetchOptions2)}else asyncData._execute({cause:"watch",dedupe:options.dedupe})},{flush:"sync"});hasScope&&onScopeDispose(()=>{unsubExecute(),unregister(key.value)})}const asyncReturn={data:writableComputedRef(()=>nuxtApp._asyncData[key.value]?.data),pending:writableComputedRef(()=>nuxtApp._asyncData[key.value]?.pending),status:writableComputedRef(()=>nuxtApp._asyncData[key.value]?.status),error:writableComputedRef(()=>nuxtApp._asyncData[key.value]?.error),refresh:__name((...args2)=>nuxtApp._asyncData[key.value].execute(...args2),"refresh"),execute:__name((...args2)=>nuxtApp._asyncData[key.value].execute(...args2),"execute"),clear:__name(()=>clearNuxtDataByKey(nuxtApp,key.value),"clear")},asyncDataPromise=Promise.resolve(nuxtApp._asyncDataPromises[key.value]).then(()=>asyncReturn);return Object.assign(asyncDataPromise,asyncReturn),asyncDataPromise}__name(useAsyncData,"useAsyncData");function writableComputedRef(getter){return computed({get(){return getter()?.value},set(value){const ref2=getter();ref2&&(ref2.value=value)}})}__name(writableComputedRef,"writableComputedRef");function _isAutoKeyNeeded(keyOrFetcher,fetcher){return!(typeof keyOrFetcher=="string"||typeof keyOrFetcher=="object"&&keyOrFetcher!==null||typeof keyOrFetcher=="function"&&typeof fetcher=="function")}__name(_isAutoKeyNeeded,"_isAutoKeyNeeded");function clearNuxtDataByKey(nuxtApp,key){key in nuxtApp.payload.data&&(nuxtApp.payload.data[key]=void 0),key in nuxtApp.payload._errors&&(nuxtApp.payload._errors[key]=void 0),nuxtApp._asyncData[key]&&(nuxtApp._asyncData[key].data.value=unref(nuxtApp._asyncData[key]._default()),nuxtApp._asyncData[key].error.value=void 0,nuxtApp._asyncData[key].status.value="idle"),key in nuxtApp._asyncDataPromises&&(nuxtApp._asyncDataPromises[key]&&(nuxtApp._asyncDataPromises[key].cancelled=!0),nuxtApp._asyncDataPromises[key]=void 0)}__name(clearNuxtDataByKey,"clearNuxtDataByKey");function pick(obj,keys){const newObj={};for(const key of keys)newObj[key]=obj[key];return newObj}__name(pick,"pick");function createAsyncData(nuxtApp,key,_handler,options,initialCachedData){nuxtApp.payload._errors[key]??=void 0;const hasCustomGetCachedData=options.getCachedData!==getDefaultCachedData,handler=_handler,_ref=options.deep?ref:shallowRef,hasCachedData=initialCachedData!==void 0,unsubRefreshAsyncData=nuxtApp.hook("app:data:refresh",async keys=>{(!keys||keys.includes(key))&&await asyncData.execute({cause:"refresh:hook"})}),asyncData={data:_ref(hasCachedData?initialCachedData:options.default()),pending:computed(()=>asyncData.status.value==="pending"),error:toRef(nuxtApp.payload._errors,key),status:shallowRef("idle"),execute:__name((...args)=>{const[_opts,newValue=void 0]=args,opts=_opts&&newValue===void 0&&typeof _opts=="object"?_opts:{};if(nuxtApp._asyncDataPromises[key]){if((opts.dedupe??options.dedupe)==="defer")return nuxtApp._asyncDataPromises[key];nuxtApp._asyncDataPromises[key].cancelled=!0}{const cachedData="cachedData"in opts?opts.cachedData:options.getCachedData(key,nuxtApp,{cause:opts.cause??"refresh:manual"});if(cachedData!==void 0)return nuxtApp.payload.data[key]=asyncData.data.value=cachedData,asyncData.error.value=void 0,asyncData.status.value="success",Promise.resolve(cachedData)}asyncData.status.value="pending";const promise=new Promise((resolve,reject)=>{try{resolve(handler(nuxtApp))}catch(err){reject(err)}}).then(async _result=>{if(promise.cancelled)return nuxtApp._asyncDataPromises[key];let result=_result;options.transform&&(result=await options.transform(_result)),options.pick&&(result=pick(result,options.pick)),nuxtApp.payload.data[key]=result,asyncData.data.value=result,asyncData.error.value=void 0,asyncData.status.value="success"}).catch(error=>{if(promise.cancelled)return nuxtApp._asyncDataPromises[key];asyncData.error.value=createError(error),asyncData.data.value=unref(options.default()),asyncData.status.value="error"}).finally(()=>{promise.cancelled||delete nuxtApp._asyncDataPromises[key]});return nuxtApp._asyncDataPromises[key]=promise,nuxtApp._asyncDataPromises[key]},"execute"),_execute:debounce((...args)=>asyncData.execute(...args),0,{leading:!0}),_default:options.default,_deps:0,_init:!0,_hash:void 0,_off:__name(()=>{unsubRefreshAsyncData(),nuxtApp._asyncData[key]?._init&&(nuxtApp._asyncData[key]._init=!1),hasCustomGetCachedData||nextTick(()=>{nuxtApp._asyncData[key]?._init||(clearNuxtDataByKey(nuxtApp,key),asyncData.execute=()=>Promise.resolve())})},"_off")};return asyncData}__name(createAsyncData,"createAsyncData");const getDefault=__name(()=>{},"getDefault"),getDefaultCachedData=__name((key,nuxtApp,ctx)=>{if(nuxtApp.isHydrating)return nuxtApp.payload.data[key];if(ctx.cause!=="refresh:manual"&&ctx.cause!=="refresh:hook")return nuxtApp.static.data[key]},"getDefaultCachedData");function useFetch(request,arg1,arg2){const[opts={},autoKey]=typeof arg1=="string"?[{},arg1]:[arg1,arg2],_request=computed(()=>toValue(request)),key=computed(()=>toValue(opts.key)||"$f"+hash([autoKey,typeof _request.value=="string"?_request.value:"",...generateOptionSegments(opts)]));if(!opts.baseURL&&typeof _request.value=="string"&&_request.value[0]==="/"&&_request.value[1]==="/")throw new Error('[nuxt] [useFetch] the request URL must not start with "//".');const{server,lazy,default:defaultFn,transform,pick:pick2,watch:watchSources,immediate,getCachedData,deep,dedupe,...fetchOptions}=opts,_fetchOptions=reactive({...fetchDefaults,...fetchOptions,cache:typeof opts.cache=="boolean"?void 0:opts.cache}),_asyncDataOptions={server,lazy,default:defaultFn,transform,pick:pick2,immediate,getCachedData,deep,dedupe,watch:watchSources===!1?[]:[...watchSources||[],_fetchOptions]};let controller;return useAsyncData(watchSources===!1?key.value:key,()=>{controller?.abort?.(new DOMException("Request aborted as another request to the same endpoint was initiated.","AbortError")),controller=typeof AbortController<"u"?new AbortController:{};const timeoutLength=toValue(opts.timeout);let timeoutId;return timeoutLength&&(timeoutId=setTimeout(()=>controller.abort(new DOMException("Request aborted due to timeout.","AbortError")),timeoutLength),controller.signal.onabort=()=>clearTimeout(timeoutId)),(opts.$fetch||globalThis.$fetch)(_request.value,{signal:controller.signal,..._fetchOptions}).finally(()=>{clearTimeout(timeoutId)})},_asyncDataOptions)}__name(useFetch,"useFetch");function generateOptionSegments(opts){const segments=[toValue(opts.method)?.toUpperCase()||"GET",toValue(opts.baseURL)];for(const _obj of[opts.params||opts.query]){const obj=toValue(_obj);if(!obj)continue;const unwrapped={};for(const[key,value]of Object.entries(obj))unwrapped[toValue(key)]=toValue(value);segments.push(unwrapped)}if(opts.body){const value=toValue(opts.body);if(!value)segments.push(hash(value));else if(value instanceof ArrayBuffer)segments.push(hash(Object.fromEntries([...new Uint8Array(value).entries()].map(([k2,v])=>[k2,v.toString()]))));else if(value instanceof FormData){const obj={};for(const entry of value.entries()){const[key,val]=entry;obj[key]=val instanceof File?val.name:val}segments.push(hash(obj))}else if(isPlainObject(value))segments.push(hash(reactive(value)));else try{segments.push(hash(value))}catch{console.warn("[useFetch] Failed to hash body",value)}}return segments}__name(generateOptionSegments,"generateOptionSegments");const _hoisted_1={class:"min-h-screen bg-neutral-50"},_hoisted_2={class:"mb-6"},_hoisted_3={class:"flex items-center justify-between"},_hoisted_4={class:"flex items-center gap-3"},_hoisted_5={class:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"},_hoisted_6={class:"text-center"},_hoisted_7={class:"text-2xl font-semibold text-gray-900"},_hoisted_8={class:"text-center"},_hoisted_9={class:"text-2xl font-semibold text-green-600"},_hoisted_10={class:"text-center"},_hoisted_11={class:"text-2xl font-semibold text-red-600"},_hoisted_12={class:"text-center"},_hoisted_13={class:"text-2xl font-semibold text-gray-900"},_hoisted_14={class:"flex flex-col md:flex-row gap-4"},_hoisted_15={class:"flex items-center gap-2"},_hoisted_16={class:"font-mono"},_hoisted_17={class:"flex items-center gap-2"},_hoisted_18={class:"px-2 py-1 bg-gray-100 rounded text-sm"},_hoisted_19={key:1,class:"text-gray-400"},_hoisted_20={class:"text-gray-600"},_hoisted_21={class:"flex items-center gap-2"},_hoisted_22={key:0,class:"mt-4 p-4 bg-gray-50 rounded-lg"},_hoisted_23={class:"flex items-center justify-between"},_hoisted_24={class:"text-sm text-gray-600"},_hoisted_25={class:"flex items-center gap-2"},_hoisted_26={class:"flex justify-end gap-3"},_hoisted_27={class:"text-center mb-4"},_hoisted_28={class:"font-mono text-lg font-semibold"},_hoisted_29={class:"text-sm text-gray-500 text-center"},_hoisted_30={key:0},_hoisted_31={class:"flex justify-between items-center w-full"},_hoisted_32={class:"flex gap-3"},_sfc_main=defineComponent({__name:"verifications",setup(__props){const communicationStore=useCommunicationStore(),tenantStore=useTenantStore(),isLoading=ref(!1),isRefreshing=ref(!1),showAddModal=ref(!1),showCodeModal=ref(!1),isSubmitting=ref(!1),isVerifying=ref(!1),isResending=ref(!1),searchQuery=ref(""),statusFilter=ref("all"),selectedRows=ref([]),verificationCode=ref(""),pendingVerification=ref(null),newMapping=ref({phoneNumber:"",userId:""}),statusOptions=[{label:"All",value:"all"},{label:"Pending",value:"pending"},{label:"Verified",value:"verified"},{label:"Expired",value:"expired"}],userOptions=ref([]),selectedUser=ref(void 0);watch(selectedUser,user=>{user&&(newMapping.value.userId=user.value)});const fetchUsers=__name(async()=>{try{const client=useSupabaseClient(),{data:{session}}=await client.auth.getSession();if(!session)throw new Error("No active session");const data=await $fetch("/api/trpc/users.list",{baseURL:useRuntimeConfig().public.apiUrl,headers:{Authorization:`Bearer ${session.access_token}`,"x-tenant-id":tenantStore.selectedTenantId||""}});if(data?.result?.data?.json)userOptions.value=data.result.data.json.map(user=>({label:user.name,value:user.id,email:user.email}));else throw new Error("No data returned")}catch{userOptions.value=[];const user=useSupabaseUser();user.value&&(userOptions.value=[{label:user.value.email?.split("@")[0]||"Current User",value:user.value.id,email:user.value.email}])}},"fetchUsers"),columns=[{id:"phoneNumber",key:"phoneNumber",label:"Phone Number",sortable:!0},{id:"verificationCode",key:"verificationCode",label:"Code"},{id:"status",key:"status",label:"Status",sortable:!0},{id:"expiresAt",key:"expiresAt",label:"Expires",sortable:!0},{id:"createdAt",key:"createdAt",label:"Created",sortable:!0},{id:"actions",key:"actions",label:"Actions"}],verifications=computed(()=>communicationStore.verifications),filteredVerifications=computed(()=>{let filtered=verifications.value;return searchQuery.value&&(filtered=filtered.filter(v=>v.phoneNumber.includes(searchQuery.value))),statusFilter.value!=="all"&&(filtered=filtered.filter(v=>statusFilter.value==="verified"?v.verified:statusFilter.value==="pending"?!v.verified&&!isExpired(v.expiresAt):statusFilter.value==="expired"?!v.verified&&isExpired(v.expiresAt):!0)),filtered}),pendingCount=computed(()=>verifications.value.filter(v=>!v.verified&&!isExpired(v.expiresAt)).length),verifiedCount=computed(()=>verifications.value.filter(v=>v.verified).length),expiredCount=computed(()=>verifications.value.filter(v=>!v.verified&&isExpired(v.expiresAt)).length),totalCount=computed(()=>verifications.value.length),breadcrumbs=[{label:"Communications",to:"/communications"},{label:"WhatsApp",to:"/communications/whatsapp"},{label:"Verifications"}];onMounted(async()=>{if(tenantStore.selectedTenantId||await tenantStore.fetchUserTenants(),!tenantStore.selectedTenantId){useNotification().error("No tenant selected","Please select a tenant to view verifications.");return}isLoading.value=!0;try{await Promise.all([fetchUsers(),communicationStore.fetchVerifications()])}catch{useNotification().error("Failed to load verifications","Unable to load verification data. Please try again.")}finally{isLoading.value=!1}});const refresh=__name(async()=>{isRefreshing.value=!0;try{await Promise.all([fetchUsers(),communicationStore.fetchVerifications()]),useNotification().success("Data refreshed")}catch{useNotification().error("Failed to refresh data","The backend API is not available.")}finally{isRefreshing.value=!1}},"refresh"),openAddModal=__name(async()=>{await fetchUsers(),newMapping.value={phoneNumber:"",userId:""},selectedUser.value=void 0,showAddModal.value=!0},"openAddModal"),clearFilters=__name(()=>{searchQuery.value="",statusFilter.value="all"},"clearFilters"),getStatusLabel=__name(row=>row.verified?"Verified":isExpired(row.expiresAt)?"Expired":"Pending","getStatusLabel"),isExpired=__name(date=>new Date(date)<new Date,"isExpired"),formatDate=__name(date=>new Date(date).toLocaleString(),"formatDate"),copyToClipboard=__name(async text=>{await navigator.clipboard.writeText(text),useNotification().success("Copied to clipboard")},"copyToClipboard"),verifyNumber=__name(async verification=>{pendingVerification.value=verification,verificationCode.value="",showCodeModal.value=!0},"verifyNumber"),resendCode=__name(async verification=>{try{const client=useSupabaseClient(),{data:{session}}=await client.auth.getSession();if(!session)throw new Error("No active session");const{data}=await useFetch("/api/trpc/communication.createVerification",{method:"POST",headers:{Authorization:`Bearer ${session.access_token}`,"x-tenant-id":tenantStore.selectedTenantId||"","Content-Type":"application/json"},body:{json:{phoneNumber:verification.phoneNumber,userId:verification.userId}}},"$RSmiXNJrzs");if(data.value?.result?.data?.json?.success)useNotification().success("Code Resent",`New verification code sent to ${verification.phoneNumber}`),await refresh();else throw new Error(data.value?.error?.json?.message||"Failed to resend code")}catch{useNotification().error("Error","Failed to resend verification code")}},"resendCode"),deleteVerification=__name(async _verification=>{useNotification().success("Verification deleted")},"deleteVerification"),exportSelected=__name(()=>{useNotification().info("Export started",`Exporting ${selectedRows.value.length} items`)},"exportSelected"),deleteSelected=__name(()=>{useNotification().success("Items deleted",`${selectedRows.value.length} items have been deleted`)},"deleteSelected"),closeModal=__name(()=>{showAddModal.value=!1,newMapping.value={phoneNumber:"",userId:""},selectedUser.value=void 0},"closeModal"),handleCodeInput=__name(event=>{const input=event.target;input.value=input.value.replace(/\D/g,""),verificationCode.value=input.value},"handleCodeInput"),submitVerificationCode=__name(async()=>{if(!(verificationCode.value.length!==6||!pendingVerification.value)){isVerifying.value=!0;try{const client=useSupabaseClient(),{data:{session}}=await client.auth.getSession();if(!session)throw new Error("No active session");const{data}=await useFetch("/api/trpc/communication.verifyCode",{method:"POST",headers:{Authorization:`Bearer ${session.access_token}`,"x-tenant-id":tenantStore.selectedTenantId||"","Content-Type":"application/json"},body:{json:{phoneNumber:pendingVerification.value.phoneNumber,code:verificationCode.value}}},"$JU679Y6oAL");if(data.value?.result?.data?.json?.success)useNotification().success("Success","Phone number verified successfully"),showCodeModal.value=!1,verificationCode.value="",pendingVerification.value=null,await refresh();else throw new Error(data.value?.error?.json?.message||"Failed to verify code")}catch(error){const errorMessage=error instanceof Error?error.message:"Failed to verify code. Please try again.";useNotification().error("Error",errorMessage)}finally{isVerifying.value=!1}}},"submitVerificationCode"),resendCodeForModal=__name(async()=>{if(pendingVerification.value){isResending.value=!0;try{await resendCode(pendingVerification.value),verificationCode.value=""}finally{isResending.value=!1}}},"resendCodeForModal"),addManualMapping=__name(async()=>{if(!newMapping.value.phoneNumber||!newMapping.value.userId){useNotification().error("Validation Error","Please fill in all required fields");return}if(!/^\+?[1-9]\d{1,14}$/.test(newMapping.value.phoneNumber)){useNotification().error("Invalid Phone Number","Please enter a valid phone number with country code (e.g., +1234567890)");return}isSubmitting.value=!0;try{const client=useSupabaseClient(),{data:{session}}=await client.auth.getSession();if(!session)throw new Error("No active session");const{data}=await useFetch("/api/trpc/communication.createVerification",{method:"POST",headers:{Authorization:`Bearer ${session.access_token}`,"x-tenant-id":tenantStore.selectedTenantId||"","Content-Type":"application/json"},body:{json:{phoneNumber:newMapping.value.phoneNumber,userId:newMapping.value.userId}}},"$K69H-J_s-J");if(data.value?.result?.data?.json?.success){closeModal(),await refresh();const newVerification=verifications.value.find(v=>v.phoneNumber===newMapping.value.phoneNumber&&!v.verified);newVerification&&(pendingVerification.value=newVerification,verificationCode.value="",showCodeModal.value=!0)}else throw new Error(data.value?.error?.json?.message||"Failed to create verification")}catch(error){const errorMessage=error instanceof Error?error.message:"Failed to add mapping. Please try again.";useNotification().error("Error",errorMessage)}finally{isSubmitting.value=!1}},"addManualMapping");return useSeoMeta({title:"WhatsApp Verifications | Figgy",description:"Manage WhatsApp phone number verifications and user mappings"}),(_ctx,_cache)=>{const _component_UBreadcrumb=resolveComponent("UBreadcrumb"),_component_UButton=resolveComponent("UButton"),_component_UCard=resolveComponent("UCard"),_component_UInput=resolveComponent("UInput"),_component_USelectMenu=resolveComponent("USelectMenu"),_component_UTable=resolveComponent("UTable"),_component_UFormField=resolveComponent("UFormField");return openBlock(),createElementBlock("div",_hoisted_1,[createVNode(unref(_sfc_main$3),{"max-width":"6xl",class:"py-8"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_2,[createVNode(_component_UBreadcrumb,{links:breadcrumbs,class:"mb-4"}),createBaseVNode("div",_hoisted_3,[_cache[9]||(_cache[9]=createBaseVNode("div",null,[createBaseVNode("h1",{class:"text-2xl font-semibold text-gray-900"},"WhatsApp Verifications"),createBaseVNode("p",{class:"mt-1 text-sm text-gray-600"}," Manage phone number verifications and user mappings ")],-1)),createBaseVNode("div",_hoisted_4,[createVNode(_component_UButton,{icon:"i-heroicons-arrow-path",variant:"soft",onClick:refresh,loading:unref(isRefreshing)},{default:withCtx(()=>_cache[7]||(_cache[7]=[createTextVNode(" Refresh ",-1)])),_:1,__:[7]},8,["loading"]),createVNode(_component_UButton,{icon:"i-heroicons-plus",onClick:openAddModal},{default:withCtx(()=>_cache[8]||(_cache[8]=[createTextVNode(" Add Manual Mapping ",-1)])),_:1,__:[8]})])])]),createBaseVNode("div",_hoisted_5,[createVNode(_component_UCard,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_6,[createBaseVNode("p",_hoisted_7,toDisplayString(unref(pendingCount)),1),_cache[10]||(_cache[10]=createBaseVNode("p",{class:"text-sm text-gray-600 mt-1"},"Pending",-1))])]),_:1}),createVNode(_component_UCard,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_8,[createBaseVNode("p",_hoisted_9,toDisplayString(unref(verifiedCount)),1),_cache[11]||(_cache[11]=createBaseVNode("p",{class:"text-sm text-gray-600 mt-1"},"Verified",-1))])]),_:1}),createVNode(_component_UCard,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_10,[createBaseVNode("p",_hoisted_11,toDisplayString(unref(expiredCount)),1),_cache[12]||(_cache[12]=createBaseVNode("p",{class:"text-sm text-gray-600 mt-1"},"Expired",-1))])]),_:1}),createVNode(_component_UCard,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_12,[createBaseVNode("p",_hoisted_13,toDisplayString(unref(totalCount)),1),_cache[13]||(_cache[13]=createBaseVNode("p",{class:"text-sm text-gray-600 mt-1"},"Total",-1))])]),_:1})]),createVNode(_component_UCard,{class:"mb-6"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_14,[createVNode(_component_UInput,{modelValue:unref(searchQuery),"onUpdate:modelValue":_cache[0]||(_cache[0]=$event=>isRef(searchQuery)?searchQuery.value=$event:null),placeholder:"Search by phone number...",icon:"i-heroicons-magnifying-glass",class:"flex-1"},null,8,["modelValue"]),createVNode(_component_USelectMenu,{modelValue:unref(statusFilter),"onUpdate:modelValue":_cache[1]||(_cache[1]=$event=>isRef(statusFilter)?statusFilter.value=$event:null),options:statusOptions,placeholder:"Filter by status",class:"w-full md:w-48"},null,8,["modelValue"]),createVNode(_component_UButton,{variant:"soft",icon:"i-heroicons-funnel",onClick:clearFilters,disabled:!unref(searchQuery)&&unref(statusFilter)==="all"},{default:withCtx(()=>_cache[14]||(_cache[14]=[createTextVNode(" Clear Filters ",-1)])),_:1,__:[14]},8,["disabled"])])]),_:1}),createVNode(_component_UCard,null,{default:withCtx(()=>[createVNode(_component_UTable,{columns,rows:unref(filteredVerifications),loading:unref(isLoading),"empty-state":{icon:"i-heroicons-shield-exclamation",label:"No verifications found"}},{"phoneNumber-data":withCtx(({row})=>[createBaseVNode("div",_hoisted_15,[createBaseVNode("span",_hoisted_16,toDisplayString(row.phoneNumber),1),createVNode(_component_UButton,{icon:"i-heroicons-clipboard-document",size:"xs",variant:"ghost",color:"neutral",onClick:__name($event=>copyToClipboard(row.phoneNumber),"onClick")},null,8,["onClick"])])]),"verificationCode-data":withCtx(({row})=>[createBaseVNode("div",_hoisted_17,[createBaseVNode("code",_hoisted_18,toDisplayString(row.verificationCode),1),createVNode(_component_UButton,{icon:"i-heroicons-clipboard-document",size:"xs",variant:"ghost",color:"neutral",onClick:__name($event=>copyToClipboard(row.verificationCode),"onClick")},null,8,["onClick"])])]),"status-data":withCtx(({row})=>[createVNode(unref(_sfc_main$1),{status:getStatusLabel(row),type:"verification",variant:"soft",size:"sm"},null,8,["status"])]),"expiresAt-data":withCtx(({row})=>[row.verified?(openBlock(),createElementBlock("span",_hoisted_19,"-")):(openBlock(),createElementBlock("span",{key:0,class:normalizeClass({"text-red-600":isExpired(row.expiresAt)})},toDisplayString(formatDate(row.expiresAt)),3))]),"createdAt-data":withCtx(({row})=>[createBaseVNode("span",_hoisted_20,toDisplayString(formatDate(row.createdAt)),1)]),"actions-data":withCtx(({row})=>[createBaseVNode("div",_hoisted_21,[!row.verified&&!isExpired(row.expiresAt)?(openBlock(),createBlock(_component_UButton,{key:0,icon:"i-heroicons-check",size:"xs",color:"success",variant:"soft",onClick:__name($event=>verifyNumber(row),"onClick")},{default:withCtx(()=>_cache[15]||(_cache[15]=[createTextVNode(" Verify ",-1)])),_:2,__:[15]},1032,["onClick"])):createCommentVNode("",!0),row.verified?createCommentVNode("",!0):(openBlock(),createBlock(_component_UButton,{key:1,icon:"i-heroicons-arrow-path",size:"xs",variant:"soft",color:"neutral",onClick:__name($event=>resendCode(row),"onClick")},{default:withCtx(()=>_cache[16]||(_cache[16]=[createTextVNode(" Resend ",-1)])),_:2,__:[16]},1032,["onClick"])),createVNode(_component_UButton,{icon:"i-heroicons-trash",size:"xs",color:"error",variant:"ghost",onClick:__name($event=>deleteVerification(row),"onClick")},null,8,["onClick"])])]),_:1},8,["rows","loading"]),unref(selectedRows).length>0?(openBlock(),createElementBlock("div",_hoisted_22,[createBaseVNode("div",_hoisted_23,[createBaseVNode("span",_hoisted_24,toDisplayString(unref(selectedRows).length)+" items selected ",1),createBaseVNode("div",_hoisted_25,[createVNode(_component_UButton,{size:"sm",variant:"soft",icon:"i-heroicons-arrow-down-tray",onClick:exportSelected},{default:withCtx(()=>_cache[17]||(_cache[17]=[createTextVNode(" Export ",-1)])),_:1,__:[17]}),createVNode(_component_UButton,{size:"sm",color:"error",variant:"soft",icon:"i-heroicons-trash",onClick:deleteSelected},{default:withCtx(()=>_cache[18]||(_cache[18]=[createTextVNode(" Delete ",-1)])),_:1,__:[18]})])])])):createCommentVNode("",!0)]),_:1}),createVNode(unref(_sfc_main$2),{open:unref(showAddModal),"onUpdate:open":_cache[4]||(_cache[4]=$event=>isRef(showAddModal)?showAddModal.value=$event:null),title:"Add Manual Mapping",description:"Map a phone number to a user in your system"},{body:withCtx(()=>[createBaseVNode("form",{onSubmit:withModifiers(addManualMapping,["prevent"]),class:"space-y-4"},[createVNode(_component_UFormField,{label:"Phone Number",name:"phoneNumber",required:""},{default:withCtx(()=>[createVNode(_component_UInput,{modelValue:unref(newMapping).phoneNumber,"onUpdate:modelValue":_cache[2]||(_cache[2]=$event=>unref(newMapping).phoneNumber=$event),placeholder:"+1234567890",icon:"i-heroicons-phone",type:"tel"},null,8,["modelValue"])]),_:1}),createVNode(_component_UFormField,{label:"User",name:"userId",required:""},{default:withCtx(()=>[createVNode(_component_USelectMenu,{modelValue:unref(selectedUser),"onUpdate:modelValue":_cache[3]||(_cache[3]=$event=>isRef(selectedUser)?selectedUser.value=$event:null),items:unref(userOptions),"label-attribute":"label","value-attribute":"value",placeholder:"Select user"},null,8,["modelValue","items"])]),_:1})],32)]),footer:withCtx(({close})=>[createBaseVNode("div",_hoisted_26,[createVNode(_component_UButton,{label:"Cancel",color:"neutral",variant:"ghost",onClick:close},null,8,["onClick"]),createVNode(_component_UButton,{label:"Add Mapping",color:"primary",loading:unref(isSubmitting),onClick:addManualMapping},null,8,["loading"])])]),_:1},8,["open"]),createVNode(unref(_sfc_main$2),{open:unref(showCodeModal),"onUpdate:open":_cache[6]||(_cache[6]=$event=>isRef(showCodeModal)?showCodeModal.value=$event:null),title:"Enter Verification Code",description:"Enter the 6-digit code sent to your WhatsApp"},{body:withCtx(()=>[createBaseVNode("form",{onSubmit:withModifiers(submitVerificationCode,["prevent"]),class:"space-y-4"},[createBaseVNode("div",_hoisted_27,[_cache[19]||(_cache[19]=createBaseVNode("p",{class:"text-sm text-gray-600"}," We've sent a verification code to ",-1)),createBaseVNode("p",_hoisted_28,toDisplayString(unref(pendingVerification)?.phoneNumber),1)]),createVNode(_component_UFormField,{label:"Verification Code",name:"code",required:""},{default:withCtx(()=>[createVNode(_component_UInput,{modelValue:unref(verificationCode),"onUpdate:modelValue":_cache[5]||(_cache[5]=$event=>isRef(verificationCode)?verificationCode.value=$event:null),placeholder:"123456",maxlength:"6",pattern:"[0-9]{6}",class:"text-center text-2xl font-mono tracking-wider",onInput:handleCodeInput},null,8,["modelValue"])]),_:1}),createBaseVNode("div",_hoisted_29,[unref(pendingVerification)?(openBlock(),createElementBlock("p",_hoisted_30," Code expires at "+toDisplayString(formatDate(unref(pendingVerification).expiresAt)),1)):createCommentVNode("",!0)])],32)]),footer:withCtx(({close})=>[createBaseVNode("div",_hoisted_31,[createVNode(_component_UButton,{label:"Resend Code",color:"neutral",variant:"ghost",size:"sm",onClick:resendCodeForModal,disabled:unref(isResending)},null,8,["disabled"]),createBaseVNode("div",_hoisted_32,[createVNode(_component_UButton,{label:"Cancel",color:"neutral",variant:"ghost",onClick:close},null,8,["onClick"]),createVNode(_component_UButton,{label:"Verify",color:"primary",loading:unref(isVerifying),disabled:unref(verificationCode).length!==6,onClick:submitVerificationCode},null,8,["loading","disabled"])])])]),_:1},8,["open"])]),_:1})])}}});export{_sfc_main as default};
